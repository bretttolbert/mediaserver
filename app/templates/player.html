<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>player</title>
    {{ JSGlue.include() }}
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    {% include 'css.html' %}
    <script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"></script>
    {% if request.args.get('hints') == "1" %}
    <script src="{{ url_for('static', filename='hints.js') }}"></script>
    {% else %}
    <script src="{{ url_for('static', filename='hints_stub.js') }}"></script>
    {% endif %}
    <script>
    let PLAYBACK_METHOD_LOCAL_ENABLED = ("{{ PLAYBACK_METHOD_LOCAL_ENABLED }}" == "True");
    let PLAYBACK_METHOD_YOUTUBE_ENABLED = ("{{ PLAYBACK_METHOD_YOUTUBE_ENABLED }}" == "True");
    let SEARCH_QUERY_URL_FORMAT = "{{ SEARCH_QUERY_URL_FORMAT }}";

    $(function() {
        // analogous to python function format_search_query_url
        // (can't use url_for here because this is an external (youtube.com) URL)
        var formatSearchQueryURL = function(artist, album, title) {
            var ret = SEARCH_QUERY_URL_FORMAT;
            ret = ret.replace("{artist}", encodeURIComponent(artist));
            ret = ret.replace("{album}", encodeURIComponent(album));
            ret = ret.replace("{title}", encodeURIComponent(title));
            return ret;
        }

        if (PLAYBACK_METHOD_LOCAL_ENABLED)
        {
            $("#audioElem")[0].addEventListener('ended', function() {
                //The repeat feature doesn't seem very useful (who wants to listen to the same song over and over??)
                //So make continuous shuffle the default (and only) behavior.
                /*
                var repeat = $("#repeatChk").prop('checked');
                if (repeat) {
                    setTimeout(function() {
                        $("#audioElem")[0].play();
                    }, 1000);
                }
                */
                loadTrack();
                $("#audioElem")[0].addEventListener('canplaythrough', function() {
                    var audio = $("#audioElem")[0];
                    if (audio.paused) {
                        audio.play();
                    }
                });
            });
            toggle_playback = function(this_elem) {
                var audio = $("#audioElem")[0];
                if (audio.paused) {
                    audio.play();
                    $("#playBtn").html('<i class="bi bi-pause-circle-fill"></i> Pause');
                }else{
                    audio.pause();
                    $("#playBtn").html('<i class="bi bi-play-circle-fill"></i> Play');
                }
            }
            $("#playBtn").click(function(){
                toggle_playback();
            });
            $("#linkTitle").click(function(){
                toggle_playback();
            })
            $("#restartBtn").click(function(){
                var audio = $("#audioElem")[0];
                audio.currentTime = 0;
                if (audio.paused) {
                    audio.play();
                }
            });
        }

        function getRequestParams() {
            const searchParams = new URLSearchParams(location.search);
            var requestParams = {};
            const scalarKeys = ["minYear", "maxYear"]; //all others are list keys
            for (const key of searchParams.keys()) {
                console.log("searchParam key=" + key);
                if (scalarKeys.includes(key)) {
                    const value = searchParams.get(key);
                    console.log("searchParams: (scalar) " + key + " = " + value);
                    requestParams[key] = value;
                } else {
                    const values = searchParams.getAll(key);
                    console.log("searchParams: (list) " + key + " = " + values);
                    requestParams[key] = values;
                }
            }
            return requestParams
        }

        function loadTrack() {
            resetHints();
            console.log("loadTrack location.search=" + location.search);
            const requestParams = getRequestParams();
            console.log("requestParams=" + JSON.stringify(requestParams));
            $.getJSON("api/track", requestParams, function(track) {
                console.log(track);
                $("#linkYear").html(track.year);
                $("#linkGenre").html(track.genre);
                $("#linkArtist").html(track.artist);
                $("#linkAlbum").html(track.album);
                $("#linkTitle").html(track.title);
                $("#coverImg").prop("src", Flask.url_for("main.getfile", {path: track.cover_path}));
                $("#linkYear").prop("href", Flask.url_for("main.albums", {year: track.year}));
                $("#linkGenre").prop("href", Flask.url_for("main.artists", {genre: track.genre}));
                $("#linkArtist").prop("href", Flask.url_for("main.albums", {artist: track.artist}));
                $("#linkAlbum").prop("href", Flask.url_for("main.tracks", {artist: track.artist, album: track.album}));
                $("#linkCover").prop("href", Flask.url_for("main.tracks", {artist: track.artist, album: track.album}));
                
                if (PLAYBACK_METHOD_LOCAL_ENABLED) {
                    let media_file_path = Flask.url_for("main.getfile", {path: track.path});
                    console.log("media_file_path: " + media_file_path);
                    $("#audioElem").prop("src", media_file_path);
                    $("#playLocalMediaLink").prop("href", Flask.url_for("main.player", {artist: track.artist, album: track.album, title: track.title}));
                }
                if (PLAYBACK_METHOD_YOUTUBE_ENABLED) {
                    $("#searchYouTubeLink").prop("href", formatSearchQueryURL(track.artist, track.album, track.title));
                }
		loadTrackHints(track);
            })
            .fail(function() { alert("error: failed to load track(s)"); });
        }
        $('#nextBtn').click(function() {
            loadTrack();
            if (PLAYBACK_METHOD_LOCAL_ENABLED) {
                $("#audioElem")[0].addEventListener('canplaythrough', function() {
                    var audio = $("#audioElem")[0];
                    if (audio.paused) {
                        audio.play();
                    }
                });
            }
        });
        loadTrack();
        //Can't autoplay initially (breaks DOM promise)
        initHints();
    });
    </script>
</head>
<body>
    {% include 'header_without_years.html' %}
    <main>
        <div id="cover">
            <a id="linkCover" href="#">
                <img src="#" id="coverImg" class="cover-img single-img" width="1000" height="1000" />
            </a>
        </div>
        <div id="playerControls">
            {% if PLAYBACK_METHOD_LOCAL_ENABLED %}
                {% if request.args.get('hints') == "1" %}
                <h1>Random track, can you name it?</h1>
                {% endif %}
                <button id="playBtn" class="btn btn-secondary btn-lg">
                    <i class="bi bi-play-circle-fill"></i> Play
                </button>
                <!--
                <input type="checkbox" id="repeatChk"/>
                <label for="repeatChk">Repeat</label>
                -->
                <button id="restartBtn" class="btn btn-secondary btn-lg">
                    <i class="bi bi-rewind-circle-fill"></i> Restart
                </button>
            {% endif %}

            <button id="nextBtn" class="btn btn-secondary btn-lg">
                <i class="bi bi-fast-forward-circle-fill"></i> Next
            </button>
            <br>
            {% if PLAYBACK_METHOD_LOCAL_ENABLED and request.args.get('hints') == "1" %}
                {% include 'hints.html' %}
            {% endif %}
        </div>
        <div id="trackList">
            <table class="playback-options">
                <tr><th>Playback Options:</th>
                    <td>
                        <table class="no-border">
                            {% if PLAYBACK_METHOD_LOCAL_ENABLED %}
                            <tr class="no-border"><td><a id="playLocalMediaLink" href="#">‚ñ∂ Local Media</a></td></tr>
                            {% endif %}
                            {% if PLAYBACK_METHOD_YOUTUBE_ENABLED %}
                            <tr class="no-border"><td><a id="searchYouTubeLink" href="#" target="_blank" rel="noopener noreferrer">üîç YouTube</a></td></tr>
                            {% endif %}
                        </table>
                    </td>
                </tr>
                <tr><th>Title:</th><td><a id="linkTitle" href="#">TITLE</a></td></tr>
                <tr><th>Artist:</th><td><a id="linkArtist" href="#">ARTIST</a></td></tr>
                <tr><th>Album:</th><td><a id="linkAlbum" href="#">ALBUM</a> </td></tr>
                <tr><th>Genre:</th><td><a id="linkGenre" href="#">GENRE</a></td></tr>
                <tr><th>Year:</th><td><a id="linkYear" href="#">YEAR</a> </td></tr>
            </table>
        </div>

        {% if PLAYBACK_METHOD_LOCAL_ENABLED %}
        <audio id="audioElem" class="full" controls>
            <source src="#" type="audio/mpeg" autoplay>
        Your browser does not support the audio element.
        </audio>
        {% endif %}

    </main>
    {% include 'footer.html' %}
</body>
</html>
